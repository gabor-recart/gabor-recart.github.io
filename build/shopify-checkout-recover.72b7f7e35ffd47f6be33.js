/*! For license information please see shopify-checkout-recover.72b7f7e35ffd47f6be33.js.LICENSE.txt */
"use strict";(self.webpackChunk_ghostmonitor_gm_tracking_js=self.webpackChunk_ghostmonitor_gm_tracking_js||[]).push([["shopify-checkout-recover"],{"./app/main/shopify-checkout-recover.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval('__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   "ShopifyCheckoutRecover": () => (/* binding */ ShopifyCheckoutRecover)\n/* harmony export */ });\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! core-js/modules/es.string.replace.js */ "./node_modules/core-js/modules/es.string.replace.js");\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! core-js/modules/web.dom-collections.iterator.js */ "./node_modules/core-js/modules/web.dom-collections.iterator.js");\n/* harmony import */ var core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_web_dom_collections_iterator_js__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var core_js_modules_es_error_cause_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! core-js/modules/es.error.cause.js */ "./node_modules/core-js/modules/es.error.cause.js");\n/* harmony import */ var core_js_modules_es_error_cause_js__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_error_cause_js__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _ghostmonitor_tracking_pixel__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @ghostmonitor/tracking-pixel */ "./node_modules/@ghostmonitor/tracking-pixel/dist/tracking-pixel.module.js");\n/* harmony import */ var query_string__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! query-string */ "./node_modules/query-string/index.js");\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./config */ "./app/main/config.js");\n/* harmony import */ var _logger__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./logger */ "./app/main/logger.ts");\n/* harmony import */ var _tracking_api__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./tracking-api */ "./app/main/tracking-api.ts");\n/* harmony import */ var _utils__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./utils */ "./app/main/utils.js");\n\n\n\n\n\n\n\n\n\nclass ShopifyCheckoutRecover {\n  constructor(sessionId) {\n    let utmParams = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    this.sessionId = sessionId;\n    this.utmParams = utmParams;\n    this.variables = _config__WEBPACK_IMPORTED_MODULE_5__["default"].variables;\n  }\n\n  async recover() {\n    _logger__WEBPACK_IMPORTED_MODULE_6__["default"].debug(\'Started Shopify recover\');\n    this.initOverlay();\n    const cartWithCheckout = await this.getCart();\n    const items = cartWithCheckout.cartItems;\n\n    if (!items || items.length < 1) {\n      this.removeOverlay();\n      return false;\n    }\n\n    await this.clearCart();\n    await this.setItems(items);\n    await this.saveCartId();\n    let encodedUrl;\n    let checkoutUrl;\n\n    if (!cartWithCheckout.shopifyOCUCheckoutId) {\n      const {\n        url,\n        query\n      } = query_string__WEBPACK_IMPORTED_MODULE_4__.parseUrl("".concat(window.parent.location.origin, "/checkout?attributes[from_ghostmonitor]=1&attributes[RecartSessionId]=").concat(this.sessionId));\n      if (this.utmParams.utm_campaign) query.utm_campaign = this.utmParams.utm_campaign;\n      if (this.utmParams.utm_source) query.utm_source = this.utmParams.utm_source;\n      if (this.utmParams.utm_medium) query.utm_medium = this.utmParams.utm_medium;\n      encodedUrl = encodeURIComponent("".concat(url, "?").concat(query_string__WEBPACK_IMPORTED_MODULE_4__.stringify(query, {\n        encode: false\n      })));\n      checkoutUrl = "https://shopify.ghostmonitor.com/redirect?u=".concat(encodedUrl);\n    } else {\n      encodedUrl = encodeURIComponent("".concat(window.parent.location.origin, "/apps/secure-checkout/").concat(cartWithCheckout.shopifyOCUCheckoutId));\n      checkoutUrl = "".concat(window.parent.location.origin, "/apps/secure-checkout/").concat(cartWithCheckout.shopifyOCUCheckoutId);\n    }\n\n    _logger__WEBPACK_IMPORTED_MODULE_6__["default"].debug(\'Finished Shopify recover, redirect\', {\n      checkoutUrl\n    });\n    window.parent.location.replace(checkoutUrl);\n    return true;\n  }\n\n  initOverlay() {\n    (0,_utils__WEBPACK_IMPORTED_MODULE_8__.addCartRecoveryOverlay)();\n  }\n\n  removeOverlay() {\n    (0,_utils__WEBPACK_IMPORTED_MODULE_8__.removeCartRecoveryOverlay)();\n  }\n\n  async clearCart() {\n    return await fetch(\'/cart/clear.js\', {\n      method: \'POST\',\n      headers: {\n        \'Content-Type\': \'application/json\'\n      }\n    });\n  }\n\n  async setItems(items) {\n    _logger__WEBPACK_IMPORTED_MODULE_6__["default"].debug(\'Recover Shopify items\', {\n      items\n    });\n    const data = {\n      items: []\n    };\n\n    for (const item of items) {\n      if (!item.variantId) {\n        throw new Error(\'Item variantId is missing\');\n      }\n\n      if (!item.qty) {\n        throw new Error(\'Item quantity is missing\');\n      }\n\n      const shopifyItem = {\n        id: item.variantId,\n        quantity: item.qty\n      };\n\n      if (item.properties) {\n        shopifyItem.properties = item.properties;\n      }\n\n      data.items.push(shopifyItem);\n    }\n\n    const response = await fetch(\'/cart/add.js\', {\n      method: \'POST\',\n      headers: {\n        \'Content-Type\': \'application/json\'\n      },\n      body: JSON.stringify(data)\n    });\n\n    if (response.ok) {\n      return await response.json();\n    }\n  }\n\n  async getCart() {\n    _logger__WEBPACK_IMPORTED_MODULE_6__["default"].debug(\'Started Shopify recover getCart()\');\n    const data = await _tracking_api__WEBPACK_IMPORTED_MODULE_7__.getShopifyCartWithCheckout();\n\n    if (data !== null && data !== void 0 && data.hasEmail) {\n      this.variables.hasEmail = data.hasEmail;\n      (0,_utils__WEBPACK_IMPORTED_MODULE_8__.saveHasEmail)(data.hasEmail);\n    }\n\n    _logger__WEBPACK_IMPORTED_MODULE_6__["default"].debug(\'Finished Shopify recover getCart()\', {\n      data\n    });\n    return data;\n  }\n\n  async saveCartId() {\n    const response = await fetch(\'/cart.js\', {\n      headers: {\n        \'Content-Type\': \'application/json\'\n      }\n    });\n\n    if (!response.ok) {\n      return;\n    }\n\n    const cart = await response.json();\n    if (!cart) return;\n    (0,_ghostmonitor_tracking_pixel__WEBPACK_IMPORTED_MODULE_3__.pixel)(\'link_shopify\', {\n      cartId: cart.token\n    });\n  }\n\n}\n\n//# sourceURL=webpack://@ghostmonitor/gm-tracking-js/./app/main/shopify-checkout-recover.ts?')}}]);