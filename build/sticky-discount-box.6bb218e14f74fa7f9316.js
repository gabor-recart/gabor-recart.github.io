/*! For license information please see sticky-discount-box.6bb218e14f74fa7f9316.js.LICENSE.txt */
"use strict";(self.webpackChunk_ghostmonitor_gm_tracking_js=self.webpackChunk_ghostmonitor_gm_tracking_js||[]).push([["sticky-discount-box"],{"./app/main/sticky-discount-box.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"init\": () => (/* binding */ init)\n/* harmony export */ });\n/* harmony import */ var core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! core-js/modules/es.array.includes.js */ \"./node_modules/core-js/modules/es.array.includes.js\");\n/* harmony import */ var core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! core-js/modules/es.string.replace.js */ \"./node_modules/core-js/modules/es.string.replace.js\");\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var lodash_memoize__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! lodash/memoize */ \"./node_modules/lodash/memoize.js\");\n/* harmony import */ var lodash_memoize__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(lodash_memoize__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var lodash_template__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! lodash/template */ \"./node_modules/lodash/template.js\");\n/* harmony import */ var lodash_template__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(lodash_template__WEBPACK_IMPORTED_MODULE_3__);\n/* harmony import */ var _logger__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./logger */ \"./app/main/logger.ts\");\n/* harmony import */ var _settings__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./settings */ \"./app/main/settings.ts\");\n/* harmony import */ var _tue_metric_collector__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./tue-metric-collector */ \"./app/main/tue-metric-collector.js\");\n/* harmony import */ var _utils__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./utils */ \"./app/main/utils.js\");\n\n\n\n\n\n\n\n\nconst metricCollector = (0,_tue_metric_collector__WEBPACK_IMPORTED_MODULE_6__.createMetricCollector)({\n  type: 'tue',\n  slug: 'sticky-discount-box'\n});\n\nconst debug = message => _logger__WEBPACK_IMPORTED_MODULE_4__[\"default\"].debug(\"\\uD83D\\uDCC4 StickyDiscountBox: \".concat(message));\n\nconst templateSettings = {\n  evaluate: /\\{\\{(.+?)\\}\\}/g,\n  interpolate: /\\{\\{=(.+?)\\}\\}/g\n};\nconst staticAssetsBaseUrl = 'https://static.ghostmonitor.com';\nconst mmeSites = [{\n  siteId: '5c1a225261aa1e0006f616a0',\n  pageId: '169247266597168',\n  sequenceId: '5eb3cf66add66ed8d27610a3'\n}, {\n  siteId: '5eacd94543e43f74714e9bc0',\n  pageId: '101424118014352',\n  sequenceId: '5ebbffd627ee1bb6f7df24b8'\n}, {\n  siteId: '5ea1fd8b1b288c814eb7b3b7',\n  pageId: '478146075569566',\n  sequenceId: '5ebe8dc99b9163000188e570'\n}, {\n  siteId: '5e9c0759ec1f1ee86f5cf109',\n  pageId: '519027051956822',\n  sequenceId: '5ec24ea41590a3d11e591999'\n}, {\n  siteId: '5bb5ef8778c38b000906a20c',\n  pageId: '195852022696',\n  sequenceId: '5e3012a6ac2730c34547e354'\n}, {\n  siteId: '5bd3431ab76f5f0007755507',\n  pageId: '195852022696',\n  sequenceId: '5eb0274f11fd38e86c0b5f0e'\n}, {\n  siteId: '5b1fec065a14930007b26c7d',\n  pageId: '147367868620883',\n  sequenceId: '5fe0db94c477060001083275'\n}, {\n  siteId: '5bd341e69f6cb6000617cd28',\n  pageId: '195852022696',\n  sequenceId: '5eb026cdb8c25b9b0e47e4ff'\n}, {\n  siteId: '5bd33f1af1deac0007a1b8ee',\n  pageId: '195852022696',\n  sequenceId: '5eb0279c4b9f3880cae3344e'\n}, {\n  siteId: '5a1b7c91a2c61b0006f95e59',\n  pageId: '1892628717680237',\n  sequenceId: '5fd8fc0b409c200001996198'\n}, {\n  siteId: '5f51446169e9e902481065ad',\n  pageId: '105148027985593',\n  sequenceId: '5ffc2b92670edc0001a7926c'\n}, {\n  siteId: '5f44b897d2a0ca3bf82b47ce',\n  pageId: '106914077343600',\n  sequenceId: '603f8db098b26000011f2419'\n}, {\n  siteId: '5d001e653c457e0b440f8bdf',\n  pageId: '2236014266695782',\n  sequenceId: '6048ce826ce1ae0001a9a27f'\n}, {\n  siteId: '5e59341c7c96b184e7e0f232',\n  pageId: '208479003000089',\n  sequenceId: '5fcf0cb75ed495000136d0e8'\n}, {\n  siteId: '60458fe748983ccf29b15eb6',\n  pageId: '146378932065526',\n  sequenceId: '6055f47f90d2f10001fdd33d'\n}, {\n  siteId: '5fb291e8a6d11fa36399b4e7',\n  pageId: '569724133226706',\n  sequenceId: '5fbebd36ae2e110001cf6ab8'\n}, {\n  siteId: '5f6e5f33c7a88e1fa0b0204d',\n  pageId: '374197609602685',\n  sequenceId: '610d3831b49ec90001067d75'\n}, {\n  siteId: '5f971f20d8bd6c3a46ed9d51',\n  pageId: '314546522554553',\n  sequenceId: '61521c1b5d55ca00013876dd'\n}, {\n  siteId: '60ffa2b24cfe96a54bf1da50',\n  pageId: '103287864939419',\n  sequenceId: '61603e5159848a000180434b'\n}, {\n  siteId: '614c907b24435997d051528d',\n  pageId: '878277429014637',\n  sequenceId: '617040349d7cc700015fe40b'\n}, {\n  siteId: '61645a57cc601e7a2b13dc5c',\n  pageId: '762619800493164',\n  sequenceId: '61afe8abfd23840001773d8c'\n}, {\n  siteId: '5f6902f85a171fc7cb0dc01e',\n  pageId: '935571679818503',\n  sequenceId: '61f7d7917102a70001a7ffeb'\n}]; // Note: we only do the validation on init, so in case of SPA we wont detect url changes\n\nconst sitesWithUrlRestrictions = [{\n  siteId: '60458fe748983ccf29b15eb6',\n  enabledPages: ['master-life-coach-certification-program']\n}];\nconst defaultTemplateData = {\n  offer: 'Get 15% Off',\n  title: 'Subscribe to Get 15% Off',\n  paragraph: 'Sign up for the best deals, latest news and get access to our new products before anyone else.',\n  checkboxCtaText: 'Subscribe',\n  subscribedViewTitle: 'Your coupon code: ',\n  discountCode: '',\n  subscribedViewParagraph: 'Sign up for the best deals and the latest news. Get access to our new products before anyone else and make sure you never miss incredible deals.',\n  subscribedViewCtaText: 'Apply discount'\n};\nlet stickyDiscountBoxSettings;\n\nfunction getIsStickyDiscountBoxEnabled(settings, siteId) {\n  const siteWithRestriction = sitesWithUrlRestrictions.find(site => site.siteId === siteId);\n  let pageEnabled = true;\n\n  if (siteWithRestriction) {\n    pageEnabled = siteWithRestriction.enabledPages.some(page => window.location.href.includes(page));\n  }\n\n  return settings.isEnabled && pageEnabled;\n}\n\nconst init = async () => {\n  stickyDiscountBoxSettings = _settings__WEBPACK_IMPORTED_MODULE_5__.get('sticky_discount_box');\n  const siteId = _settings__WEBPACK_IMPORTED_MODULE_5__.get('site_id');\n  const isStickyDiscountBoxEnabled = getIsStickyDiscountBoxEnabled(stickyDiscountBoxSettings, siteId);\n  const fbSettings = _settings__WEBPACK_IMPORTED_MODULE_5__.get('fb_messenger');\n  const isFacebookConnected = fbSettings === null || fbSettings === void 0 ? void 0 : fbSettings.config.isEnabled;\n\n  if (isStickyDiscountBoxEnabled && isFacebookConnected) {\n    debug('initializing Sticky Discount Box');\n    let stickyDiscountBoxTemplate;\n\n    try {\n      const response = await fetch(\"\".concat(staticAssetsBaseUrl, \"/tue/sticky-discount-box/default/template.html\"));\n      stickyDiscountBoxTemplate = await response.text();\n    } catch (e) {\n      console.log(\"Couldn't get stickyDiscountBoxTemplate html from S3\");\n      throw e;\n    }\n\n    let modalTemplate = stickyDiscountBoxTemplate.replace(/{{=assetsLink}}/g, \"\".concat(staticAssetsBaseUrl, \"/tue/sticky-discount-box/default/assets\"));\n    modalTemplate = updateTemplate(modalTemplate);\n    const hiddenModal = prepareModalElement(modalTemplate);\n    const show = shouldRenderMmeLink() || (await waitForMessengerWidgetToRender(hiddenModal));\n\n    if (show) {\n      showModal();\n      metricCollector.send('IMPRESSION');\n    }\n  }\n};\n\nasync function waitForMessengerWidgetToRender(modalElement) {\n  const checkIntervalMillisec = 100;\n  const maxWaitForRenderMillisec = 10 * 1000;\n  let checkedCount = 0;\n  return new Promise((resolve, reject) => {\n    function checkIfMessengerWidgetRendered() {\n      const widgetContainer = modalElement.querySelector('.recart-messenger-widget');\n\n      if (widgetContainer.getAttribute('rendered') === 'hidden') {\n        debug('Widget forcefully has been hidden.');\n        return resolve(false);\n      }\n\n      if (checkIntervalMillisec * checkedCount++ > maxWaitForRenderMillisec) {\n        debug(\"Max wait for render \".concat(maxWaitForRenderMillisec, \"ms elapsed.\"));\n        return resolve(false);\n      } // The rendered attribute alone is not enough, because it's given before we receive the rendered event from FB\n\n\n      if (widgetContainer.getAttribute('rendered') === 'rendered' && widgetContainer.classList.contains('_rmp-state--initial') && widgetContainer.classList.contains('_rmp-fb-force')) {\n        resolve(true);\n      } else {\n        setTimeout(checkIfMessengerWidgetRendered, checkIntervalMillisec);\n      }\n    }\n\n    checkIfMessengerWidgetRendered();\n  });\n}\n\nconst prepareModalElement = lodash_memoize__WEBPACK_IMPORTED_MODULE_2___default()(modalTemplate => {\n  const modalElement = _utils__WEBPACK_IMPORTED_MODULE_7__._window.document.createElement('div');\n\n  modalElement.innerHTML = modalTemplate;\n\n  _utils__WEBPACK_IMPORTED_MODULE_7__._window.document.querySelector('body').appendChild(modalElement);\n\n  return modalElement;\n});\n\nfunction showModal() {\n  let closedView = {};\n  let mainView = {};\n  let subscribedView = {};\n\n  function showClosedView() {\n    closedView.style.display = 'flex';\n    mainView.style.display = 'none';\n    subscribedView.style.display = 'none';\n  }\n\n  function showMainView() {\n    closedView.style.display = 'none';\n    mainView.style.display = 'flex';\n    subscribedView.style.display = 'none';\n  }\n\n  function showSubscribedView() {\n    closedView.style.display = 'none';\n    mainView.style.display = 'none';\n    subscribedView.style.display = 'flex';\n  }\n\n  const discountBox = _utils__WEBPACK_IMPORTED_MODULE_7__._window.document.getElementsByClassName('sticky-discount-box')[0];\n\n  closedView = discountBox.getElementsByClassName('sticky-discount-box__discount-button')[0];\n  closedView.addEventListener('click', function (e) {\n    showMainView();\n    metricCollector.send('ENGAGEMENT');\n  }, false);\n  mainView = discountBox.getElementsByClassName('sticky-discount-box__discount-panel--subscribe')[0];\n  const subscribeButton = mainView.querySelector('.sticky-discount-box__discount-panel__subscribe-button-wrapper');\n  subscribeButton.addEventListener('click', function (e) {\n    showSubscribedView();\n    metricCollector.send('OPTIN');\n  }, false);\n  subscribedView = discountBox.getElementsByClassName('DiscountPanel--coupon')[0];\n  const applyDiscountButton = subscribedView.getElementsByClassName('sticky-discount-box__apply-discount-button')[0];\n  applyDiscountButton.addEventListener('click', function (e) {\n    const discountContainer = subscribedView.getElementsByClassName('sticky-discount-box__discount-panel__content__coupon')[0];\n    copyDiscountCodeToClipboard(discountContainer);\n    showClosedView();\n  }, false);\n  const closeButtons = discountBox.getElementsByClassName('sticky-discount-box__close');\n  Array.prototype.forEach.call(closeButtons, button => {\n    button.addEventListener('click', function (e) {\n      showClosedView();\n      metricCollector.send('CLOSE');\n    }, false);\n  });\n  showClosedView();\n}\n\nfunction copyDiscountCodeToClipboard(discountCodeContainer) {\n  if (_utils__WEBPACK_IMPORTED_MODULE_7__._window.document.body.createTextRange) {\n    const range = _utils__WEBPACK_IMPORTED_MODULE_7__._window.document.body.createTextRange();\n\n    range.moveToElementText(discountCodeContainer);\n    range.select();\n  } else if (_utils__WEBPACK_IMPORTED_MODULE_7__._window.getSelection) {\n    const selection = _utils__WEBPACK_IMPORTED_MODULE_7__._window.getSelection();\n\n    const range = _utils__WEBPACK_IMPORTED_MODULE_7__._window.document.createRange();\n\n    range.selectNodeContents(discountCodeContainer);\n    selection.removeAllRanges();\n    selection.addRange(range);\n  }\n\n  if (_utils__WEBPACK_IMPORTED_MODULE_7__._window.document.execCommand('copy')) {\n    debug('Discount code has been copied to clipboard.');\n  }\n}\n\nfunction getTemplateData() {\n  let templateData = {};\n\n  try {\n    const templateDataRaw = stickyDiscountBoxSettings.textSchema;\n    Object.keys(templateDataRaw).forEach(function (key) {\n      templateData[key] = templateDataRaw[key].value;\n    });\n  } catch (e) {\n    templateData = defaultTemplateData;\n  }\n\n  templateData.widgetType = 'checkbox_with_cta';\n  templateData.messengerSubscriptionSource = 'sticky_discount_box';\n  templateData.mme = shouldRenderMmeLink();\n  return templateData;\n}\n\nfunction shouldRenderMmeLink() {\n  const siteId = _settings__WEBPACK_IMPORTED_MODULE_5__.get('site_id');\n  return mmeSites.some(siteInfo => siteInfo.siteId === siteId);\n}\n\nfunction updateCssInTemplate(originalHtml, designSchema) {\n  let replacedCss = originalHtml;\n  Object.keys(designSchema).forEach(key => {\n    const replace = \"\\\"@@\".concat(key, \"\\\"\");\n    const regex = new RegExp(replace, 'g');\n    replacedCss = replacedCss.replace(regex, designSchema[key].value);\n\n    if (['checkbox-skin', 'icon'].includes(key)) {\n      replacedCss = replacedCss.replace(\"&quot@@\".concat(key, \"&quot\"), designSchema[key].value);\n    }\n  });\n  return replacedCss;\n}\n\nfunction updateMmeLink(originalHtml) {\n  const siteId = _settings__WEBPACK_IMPORTED_MODULE_5__.get('site_id');\n  const input = mmeSites.find(siteInfo => siteInfo.siteId === siteId);\n\n  if (!input) {\n    return originalHtml;\n  }\n\n  let result = originalHtml;\n  Object.keys(input).forEach(key => {\n    const replace = \"@@\".concat(key);\n    const regex = new RegExp(replace, 'g');\n    result = result.replace(regex, input[key]);\n  });\n  return result;\n}\n\nfunction updateTemplate(modalTemplate) {\n  var _stickyDiscountBoxSet, _stickyDiscountBoxSet2;\n\n  const templateData = getTemplateData();\n  modalTemplate = lodash_template__WEBPACK_IMPORTED_MODULE_3___default()(modalTemplate, templateSettings)(templateData);\n  const designSchema = (_stickyDiscountBoxSet = (_stickyDiscountBoxSet2 = stickyDiscountBoxSettings) === null || _stickyDiscountBoxSet2 === void 0 ? void 0 : _stickyDiscountBoxSet2.designSchema) !== null && _stickyDiscountBoxSet !== void 0 ? _stickyDiscountBoxSet : {};\n  modalTemplate = updateCssInTemplate(modalTemplate, designSchema);\n  modalTemplate = updateMmeLink(modalTemplate);\n  return modalTemplate;\n}\n\n//# sourceURL=webpack://@ghostmonitor/gm-tracking-js/./app/main/sticky-discount-box.js?")},"./app/main/tue-metric-collector.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval('__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   "createMetricCollector": () => (/* binding */ createMetricCollector)\n/* harmony export */ });\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! core-js/modules/es.string.replace.js */ "./node_modules/core-js/modules/es.string.replace.js");\n/* harmony import */ var core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_string_replace_js__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! core-js/modules/es.array.includes.js */ "./node_modules/core-js/modules/es.array.includes.js");\n/* harmony import */ var core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(core_js_modules_es_array_includes_js__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var _ghostmonitor_tracking_pixel__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @ghostmonitor/tracking-pixel */ "./node_modules/@ghostmonitor/tracking-pixel/dist/tracking-pixel.module.js");\n/* harmony import */ var local_storage_fallback__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! local-storage-fallback */ "./node_modules/local-storage-fallback/lib/index.js");\n/* harmony import */ var _logger__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./logger */ "./app/main/logger.ts");\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./config */ "./app/main/config.js");\n\n\n\n\n\n\n/**\n * @param {Object} arg1\n * @param {string} arg1.slug\n * @param {string} arg1.type\n */\n\nfunction createMetricCollector(_ref) {\n  let {\n    type,\n    slug\n  } = _ref;\n  const metricPrefix = "".concat(type.toUpperCase(), "_").concat(slug.toUpperCase(), "_").replace(/-/g, \'_\');\n\n  const send = function (type) {\n    var _storage$getItem, _storage$getItem2;\n\n    let once = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    const metricName = metricPrefix + type;\n    const key = "recart_".concat(_config__WEBPACK_IMPORTED_MODULE_5__["default"].variables.sessionId, "_metrics");\n    if (once && (_storage$getItem = local_storage_fallback__WEBPACK_IMPORTED_MODULE_3__["default"].getItem(key)) !== null && _storage$getItem !== void 0 && _storage$getItem.replace(/"/g, \'\') && (_storage$getItem2 = local_storage_fallback__WEBPACK_IMPORTED_MODULE_3__["default"].getItem(key)) !== null && _storage$getItem2 !== void 0 && _storage$getItem2.replace(/"/g, \'\').includes(metricName)) return;\n\n    try {\n      (0,_ghostmonitor_tracking_pixel__WEBPACK_IMPORTED_MODULE_2__.pixel)(\'metric\', {\n        metricName,\n        metricValue: 1\n      });\n    } catch (err) {\n      _logger__WEBPACK_IMPORTED_MODULE_4__["default"].error(\'Failed to track metric\', {\n        error: err,\n        metricName\n      });\n    }\n\n    if (once) {\n      var _storage$getItem3;\n\n      let trackedMetrics = ((_storage$getItem3 = local_storage_fallback__WEBPACK_IMPORTED_MODULE_3__["default"].getItem(key)) === null || _storage$getItem3 === void 0 ? void 0 : _storage$getItem3.replace(/"/g, \'\')) || \'\';\n      trackedMetrics += "".concat(metricName, ",");\n      local_storage_fallback__WEBPACK_IMPORTED_MODULE_3__["default"].setItem(key, trackedMetrics);\n    }\n  };\n\n  return {\n    send\n  };\n}\n\n//# sourceURL=webpack://@ghostmonitor/gm-tracking-js/./app/main/tue-metric-collector.js?')}}]);